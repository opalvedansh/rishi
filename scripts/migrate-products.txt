import { createClient } from "@supabase/supabase-js";
import { products } from "../src/data/products";
import * as dotenv from "dotenv";

dotenv.config({ path: ".env.local" });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, // Using ANON key, RLS should be open or we should use SERVICE_ROLE key for admin tasks
);

async function migrate() {
    console.log("Starting migration...");

    for (const product of products) {
        const { id, images, ...productData } = product;

        // 1. Insert Product
        const { error } = await supabase.from("products").upsert({
            ...productData,
            images: images, // Assuming JSONB or array column
            // If ID is UUID in DB and string in JS, we might need to omit ID or generate one.
            // But for now let's assume we can keep the string ID or let Supabase generate one.
            // If Supabase products table expects uuid, we should not send numeric string IDs.
            // If we want consistency, we should maybe rely on 'handle' as unique key or let Supabase generate UUIDs.
            // Let's assume we map 'id' to something or omit it if it's auto-generated.
        }).select();

        if (error) {
            console.error(`Error migrating ${product.title}:`, error);
        } else {
            console.log(`Migrated ${product.title}`);
        }
    }

    console.log("Migration complete.");
}

migrate();
